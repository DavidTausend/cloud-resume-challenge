---
- name: Destroy GCS static site bucket via Terraform (ADC + Terraform Cloud)
  hosts: localhost
  connection: local
  gather_facts: false

  vars_files:
    - vaults/prod.yml

  vars:
    project_path: "{{ playbook_dir }}/.."
    tf_vars_file: "{{ project_path }}/terraform.tfvars"

  tasks:
    - name: "Verify ADC is available (run: gcloud auth application-default login)"
      ansible.builtin.command: gcloud auth application-default print-access-token
      register: adc_token
      changed_when: false
      environment:
        GOOGLE_APPLICATION_CREDENTIALS: "{{ omit }}"

    - name: Terraform init and destroy (Terraform Cloud)
      community.general.terraform:
        project_path: "{{ project_path }}"
        force_init: true
        state: absent
        variables_files:
          - "{{ tf_vars_file }}"
      environment:
        GOOGLE_PROJECT: "{{ gcp_project_id }}"
        GOOGLE_REGION: "{{ gcp_region }}"
        GOOGLE_APPLICATION_CREDENTIALS: "{{ omit }}"
        GOOGLE_OAUTH_ACCESS_TOKEN: "{{ adc_token.stdout }}"
        TF_VAR_bucket_name: "{{ omit }}"
        TF_TOKEN_app_terraform_io: "{{ tfc_token }}"
      register: tf_destroy

    - name: Show Terraform destroy output (if any)
      ansible.builtin.debug:
        var: tf_destroy